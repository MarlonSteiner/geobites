<div class="d-flex justify-content-center mb-12">
  <div id="map"></div>
</div>

<!--The JS code structure was taken from Mapbox Docs AI and then I worked from there. Don't think there was anyway I could have written this from scratch-->
<script>
  mapboxgl.accessToken = "<%= ENV["MAPBOX_TOKEN"] %>";

  const map = new mapboxgl.Map({
    container: "map",
    style: "mapbox://styles/mapbox/standard-satellite",
    projection: "globe",
    zoom: 1.5,
    center: [0, 20]
  });

  // Empty changable variable to store the current bookmarkId in
  let currentOutputId;

  map.on('click', async (e) => {

    const { lat, lng } = e.lngLat;

    // Call Mapbox reverse geocoding
    const response = await fetch(`https://api.mapbox.com/geocoding/v5/mapbox.places/${lng},${lat}.json?access_token=${mapboxgl.accessToken}&types=place,country`);
    // Here I found why it wasn't working to fetch! I'm expecting json afterall...
    const data = await response.json();

    const city = data.features[0]?.text || 'Unknown';
    const country = data.features[0]?.context?.find(c => c.id.includes('country'))?.text || 'Unknown';

    console.log('City:', city);
    console.log('Country:', country);
    // Display it
    //document.getElementById("city").textContent = city;
    //document.getElementById("country").textContent = country;
    // I ended up making "location" because it seemed like the easiest way to join city and country together in one line
    document.getElementById("location").textContent = `${city}, ${country}`;

    // fetch and send to select in home_controller
    // I was stuck here the longest.
    //https://developer.mozilla.org/en-US/docs/Web/API/FormData/append
    const formData = new FormData();
    formData.append("country", country);
    formData.append("city", city);
    formData.append("latitude", lat);
    formData.append("longitude", lng);
    // https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API/Using_Fetch
    //const response = await fetch("https://example.org/post", {
      //method: "POST",
      //body: JSON.stringify({ username: "example" }),
      // â€¦
    //});
    // I ended up using the Legon fetching Template from their docs
    fetch("/select", {
      method: "POST",
      headers: { "Accept": "application/json" },
      body: formData
    })
    .then(response => response.json())
    .then((data) => {
      console.log(data);
      // Here we select data using vanilla JS through the DOM
      document.getElementById("output-text").textContent = data.output;
      // I added this line to make sure the bookmark appears the same time as the text output.
      document.getElementById("bookmark-link").style.display = "inline";

      //save the current output_id for bookmarking
      currentOutputId = data.output_id;
    });
  });

  // Bookmark handling that I will transfer to a separate js file if it doesn't break.
  document.addEventListener("DOMContentLoaded", function() {
    const bookmarkLink = document.getElementById("bookmark-link");
    if (bookmarkLink) {
      bookmarkLink.addEventListener("click", function() {
        console.log("Bookmark clicked");
        console.log("Current output ID:", currentOutputId);

        const bookmarkData = new FormData();
        bookmarkData.append("output_id", currentOutputId);

        fetch("/bookmarks", {
          method: "POST",
          headers: { "Accept": "application/json" },
          body: bookmarkData
        })
        .then(response => {
          console.log("Bookmark saved");

        // Toggle icon depending on state
        const bookmarkIcon = document.querySelector("#bookmark-link img");
        bookmarkIcon.src = bookmarkIcon.src.includes("untoggled")
          ? "<%= asset_path("bookmark-icon-toggled.svg") %>"
          : "<%= asset_path("bookmark-icon-untoggled.svg") %>"
      });
    });
    }
  });
</script>
